\documentclass[10pt, a4paper, italian]{article}
\input{../../latex/preamble}
\input{../../latex/math}
\geometry{left=2cm, right=2cm, top=2cm, bottom=2cm}

% indexes subsections with letters, sections with numbers (1.a, 1.b, ...)
\renewcommand{\thesubsection}{\thesection.\alph{subsection}}

% lets graphicx know path where figures to be included are found
\graphicspath{{../figs/}}

\author{Gruppo 1.AC \\ Matteo Rossi, Bernardo Tomelleri}
\title{Es05A: Applicazioni non-lineari di amplificatori operazionali}
\begin{document}
\date{\today}
\maketitle

\setcounter{section}{0}

\section*{Misura componenti dei circuiti}
\begin{table}[htbp]
\centering
\begin{tabular}{cccccc}
\toprule
Resistenze $[\si{k\ohm}]$ & $R$ & $\sigma R$ & Capacità $[\si{n\F}]$ & $C$ &
$\sigma C$ \\
\midrule
\midrule
$R_1^Q$	  & 100.6 	& 0.8 	 & $C_T$ & 1.00		 & 0.04 \\
$R_1^T$	  & 9.94	& 0.08 	 & $C_F$ & 1.00		 & 0.04 \\
$R_2^T$	  & 2.19	& 0.03	 & $C_1$ & 96		 & 4	\\
$R_2^a$	  & 9.94	& 0.08	 & $C_2$ & 1.00		 & 0.04 \\
$R_3$	  & 9.92	& 0.08	 & & & \\
$R_4$	  & 9.94	& 0.08	 & & & \\
\bottomrule     
\end{tabular}
\caption{Valori di resistenza e capacità misurate per i componenti dei
circuiti studiati. \label{tab: rcmes_B}}

\begin{tabular}{cccccc}
\toprule
Resistenze $[\si{\ohm}]$ & $R$ & $\sigma R$ & Capacità $[\si{n\F}]$ & $C$ &
$\sigma C$ \\
\midrule
\midrule
$R_1^Q$	  & 99.8 	& 0.8 	 & $C_T$ & 1.00		 & 0.04 \\
$R_1^T$	  & 9.94	& 0.08 	 & $C_F$ & 1.00		 & 0.04 \\
$R_2^T$	  & 2.19	& 0.03	 & $C_1$ & 99		 & 4	\\
$R_2^A$	  & 9.87		& 0.08		 & $C_2$ & 1.00		 & 0.04 \\
$R_3^A$	  & 10.01		& 0.08		 & & & \\
$R_4^M$	  & 9.91		& 0.08		 & & & \\
\bottomrule     
\end{tabular}
\caption{Valori di resistenza e capacità misurate per i componenti dei
circuiti studiati. \label{tab: rcmes_M}}
\end{table}

Riportiamo per completezza anche i valori delle tensioni di alimentazione
continue per l'op-amp misurate con il multimetro
\begin{align*}
V_{CC} &= 4.99 \pm 0.03 \si{\V} \\
V_{EE} &= -4.99 \pm 0.03 \si{\V}
\end{align*}

Non è stato facile misurare i valori di capacità dei condensatori nel
circuito con il multimetro, che a volte con i soli puntali collegati legge
un rumore di fondo intorno ai $7 \pm 1 \; \si{n\F}$, abbastanza alto da
saturare il fondo scala da $\SI{2}{n\F}$ con cui si vorrebbero misurare i
valori delle capacità $C_T$, $C_F$ e $C_2$.

Per tutto il resto della trattazione come ampiezze dei segnali si intendono
misurate non ``picco - picco'', a meno che non venga esplicitato altrimenti.

\subsection*{Nota sul metodo di fit}
Per determinare i parametri ottimali e le rispettive covarianze si \`e
implementato in \verb+Python+ un algoritmo di fit basato sui minimi quadrati
mediante la funzione \emph{curve\_fit} della libreria \texttt{SciPy}.

%=======================
\section{Circuito amplificatore di carica}
\subsection{Progettazione del circuito}
Si è costruito un amplificatore di carica a partire da un op-amp TL081CP come
quello in figura \ref{fig: Qampschm}

\begin{figure}[htbp]
    \centering
	\includegraphics[scale=1.2]{Qamp}
    \caption{Schema circuitale dell'amplificatore di carica costruito.
    \label{fig: Qampschm}}
\end{figure}

In cui abbiamo indicato i sotto-circuiti di cui è composto, da sinistra verso
destra come: ``iniettore/rivelatore di carica'', ``circuito formatore/shaper''
(passa-basso/integratore attivo) e ``discriminatore/comparatore''.

\subsection{Funzionamento di iniettore e shaper}
Si è inviato all'ingresso di entrambi i circuiti un'onda quadra di
ampiezza $V_s = 999 \pm 8 \si{m\V}$ e frequenza fissata a
$f = 100.0 \pm 1.6 \; \si{\Hz}$, che corrisponde ad una carica
$Q\ped{in} = C_T \cdot 2V_s = 1.98 \pm 0.08 \; \si{n\coulomb}$, proporzionale
al ``salto'' di tensione dal livello alto a basso (e viceversa) dell'onda,
più semplicemente alla sua ampiezza picco-picco
$V_s^{pp} = 2 V_s \implies Q\ped{in} = C_T \cdot V_s^{pp}$.

Dunque abbiamo trovato come segnale in uscita dal circuito formatore un
segnale che dopo un breve transiente diventa un esponenziale decrescente,
con ampiezza iniziale $V\ped{sh} (t=0) = 2007 \pm 18 \; \si{m\V}$ e
con la stessa frequenza $99.9 \pm 1.6 \; \si{\Hz}$ dell'onda quadra.
Riportiamo in figura l'immagine acquisita dall'oscilloscopio con dettaglio
sul transiente al fronte di discesa dell'onda quadra.
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.335]{shaperzoom}
    \caption{Acquisizione del segnale in uscita dal circuito formatore con
    un'onda quadra in ingresso $V_s = \SI{1}{V}$, $f = \SI{100}{\Hz}$
    \label{fig: shzoom}}
\end{figure}

Assumendo iniezione di carica istantanea sulle armature dei condensatori $C_T$
e $C_F$, il segnale in uscita dal sotto-circuito formato da $C_T$ e dal
formatore è legato al segnale in ingresso dalla relazione
\begin{align}\label{eq:Vsh}
V\ped{sh}(t) &= \frac{Q\ped{in}}{C_F} e^{-t/\tau} =
2V_s(t) \frac{C_T}{C_F} e^{-t/\tau} \\
\tau &= R_1 C_F
\end{align}
Per i circuiti in esame i valori delle capacità sono
$C_T \approx C_F = \SI{1}{n\F}$ e $R_1 = \SI{100}{\kilo\ohm}$,
per cui possiamo semplificare il rapporto $C_T/C_F \approx 1$, da cui
ricaviamo come valori attesi
\begin{align*}
V\ped{sh}(t) &= 2V_s(t) e^{-t/\tau} \\
\tau &= R_1 C_F = 100 \pm 4 \; \si{\micro\s}
\end{align*}
Quindi complessivamente come tensione in uscita $V\ped{sh} (t)$ ci aspettiamo
di osservare una serie di picchi seguiti da decrescite esponenziali di segno
alternante con l'onda quadra in ingresso e di ampiezza doppia.

Questo risulta compatibile con quanto si è osservato dall'oscilloscopio, che
riportiamo per chiarezza in figura~\ref{fig: shaper}
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.335]{shaper}
    \caption{Onda quadra in ingresso $V_s = \SI{1}{V}$, $f = \SI{100}{\Hz}$
    su CH1 e segnale in uscita dal circuito formatore $V\ped{sh}$ su CH2.
    \label{fig: shaper}}
\end{figure}

Dunque possiamo controllare che la forma d'onda esponenziale sia compatibile
con quanto atteso dalla \eqref{eq:Vsh} tramite un fit ai punti campionati
dall'AD2, di cui riportiamo brevemente i risultati
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.6]{tau}
    \caption{Fit con esponenziale decrescente al segnale in uscita dal
    circuito formatore $V\ped{sh}$ \label{fig: tau}}
\end{figure}
\begin{align*}
V\ped{sh} (t=0) &= 2021 \pm 2 \; \si{m\V}
&\tau = 101.88 \pm 0.03 \; \si{\micro\s} \\
\chi^2/\mathrm{ndof} &= 2774/4086 &\mathrm{cov_{norm}} = -0.75
\end{align*}

Da cui vediamo come non solo la misura di ampiezza iniziale sia compatibile
con il valore misurato, ma anche il tempo caratteristico di smorzamento $\tau$
risulta pienamente in accordo con il valore atteso dai componenti del
circuito.

\setcounter{subsection}{3}
\subsection{Funzionamento del discriminatore}\label{sub: discr}
Il sotto-circuito discriminatore è un comparatore con tensione di soglia
misurata con l'oscilloscopio $V\ped{thr} = 51.9 \pm 0.4 \si{m\V}$ e fornita
dal generatore di tensione (con valore nominale $\SI{60}{m\V}$) \verb+W2+
collegato all'ingresso invertente del secondo OpAmp.

Supponiamo di essere sempre in regime di saturazione per l'OpAmp ideale e
come prima assumiamo iniezione istantanea di carica sui condensatori. 
Grazie al fatto che le tensioni di alimentazione sono pari in modulo
$V_{CC} = - V_{EE}$ possiamo prendere come segnale atteso in uscita
\begin{equation}\label{eq: Vdiscr}
V\ped{discr} (t) = V_{CC} \sgn\left[V\ped{sh}(t) - V\ped{thr}\right].
\end{equation}

Più esplicitamente, ricordando che $V\ped{sh}$ ha ampiezza (iniziale) doppia
rispetto all'ampiezza in ingresso $V_s$ (o proporzionale a $V_s^{pp}$)
\begin{itemize}
\item se $V_s^{pp} < V\ped{thr} \implies V\ped{discr} = V_{EE}$ costante.
\item se $V_s^{pp} \geq V\ped{thr}$, ci aspettiamo (in un periodo dell'onda
quadra di durata $T = 9.99 \pm 0.16 \; \si{m\s}$)
\[
V\ped{discr}(t) =
\begin{cases}
V_{CC} & 0 < t < ToT \\
V_{EE} & ToT < t < T
\end{cases}
\]
In cui $ToT$ è il tempo in cui il picco esponenzialmente decrescente è
maggiore della tensione di soglia
$V\ped{sh}(t) = \frac{Q\ped{in}}{C_F} e^{-t/\tau} \geq V\ped{thr}$, appunto il
``Time-over-Threshold''.
\begin{equation} \label{eq:ToT}
ToT = \tau \log\left(\frac{Q\ped{in}}{C_F V\ped{thr}}\right) =
\tau \log\left(\frac{C_T V_s^{pp}}{C_F V\ped{thr}}\right) = 
\tau \log\left(\frac{C_T}{C_F} \frac{2 V_s}{V\ped{thr}}\right).
  \end{equation}
\end{itemize}

Mantenendo lo stesso segnale in ingresso al circuito del punto precedente
(con ampiezza ben oltre la soglia $V_s \gg V\ped{thr}$) riportiamo il
segnale visualizzato all'oscilloscopio in uscita dal discriminatore in figura
\ref{fig: discr}.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{discrzoom}
\caption{Acquisizione del segnale in uscita dal circuito comparatore con
un'onda quadra in ingresso $V_s = \SI{1}{V}$, $f = \SI{100}{\Hz}$
\label{fig: discr}}
\end{figure}

Risulta già chiaro dal dettaglio a destra, in corrispondenza del fronte di
discesa dell'onda quadra, come il segnale in uscita non abbia né livelli basso
e alto simmetrici rispetto a $\SI{0}{V}$, né pendenza uguale (idealmente
infinita) nel passaggio tra questi due, al contrario di quanto atteso dal
nostro modello semplificato.

Possiamo caratterizzare il segnale $V\ped{discr} (t)$ trovato come un impulso
di tensione con livello basso $V_{OL}$ e livello alto $V_{OH}$ di durata
$T_{OH}$ che si ripete periodicamente con la stessa frequenza dell'onda quadra
in ingresso $V_s (t)$.
Riportiamo le misure dirette effettuate con i cursori
delle tensioni di saturazione del comparatore e una misura del tempo ``alto''
dell'impulso definita in maniera compatibile con la funzione automatica di
misura ``PosWidth'' (cioè come il tempo in cui la tensione si trova al di
sopra della metà del valore positivo dell'impulso, che quindi sovrastima
per la pendenza decisamente non ideale dei fronti d'onda).
\begin{align*}
V_{OH} &= 4.38 \pm 0.03 \; \si{\V} \\
V_{OL} &= -3.53 \pm 0.02 \; \si{\V} \\
T_{OH} &= 416 \pm 5 \; \si{\micro\s}
\end{align*}

Osserviamo quindi che i valori di saturazione alta e bassa misurati non sono
compatibili con quelli attesi, ma sono entrambi inferiori (in modulo). Questo
può essere dovuto al fatto che in realtà il TL081 in regime di saturazione
produce al massimo tensioni entro il suo (Maximum Output) \emph{Voltage swing}
riportato come valore tipico nel datasheet $V\ped{OM, typ} = 13.5$,
sensibilmente inferiore rispetto al valore di tensione di alimentazione tipico
a cui è riferito $V\ped{CC, typ} = 15 \; \si{\V}$.

Quindi, volendo ragionare per analogia ci aspettiamo un escursione massima tra
le tensioni di saturazione (date le nostre tensioni di alimentazione a
$\pm \SI{5}{\V}$) $V_{OM} = 13.5 \cdot V_{CC} / V\ped{CC, typ} =
13.5 /3 = 4.5 \; \si{\V}$, che risulta sicuramente più vicino a quanto
abbiamo misurato.

\subsection{Durata impulso per carica di test}
Abbiamo scelto come ampiezza per l'onda quadra $V_s = 999 \pm 8 \si{m\V}$ e
frequenza $f = 100.0 \pm 1.6 \; \si{k\Hz}$, dunque come carica
iniettata $Q\ped{in} = C_T \cdot 2 V_s = 1.98 \pm 0.08 \; \si{n\coulomb}$.
Si è scelta una frequenza abbastanza bassa, con periodo corrispondente a
$1/f = T \gg \tau$ di modo che tra una iniezione di carica e l'altra (cioè tra
ogni semiperiodo dell'onda quadra $V_s (t)$) i condensatori abbiano tempo di
scaricarsi, così da poter considerare indipendente ogni iniezione di carica
dalla precedente.

L'impulso in uscita ha durata pari a $416 \pm 5 \; \si{\micro\s}$ in un
circuito e $378 \pm 5 \; \si{\micro\s}$ nel secondo.

Per quanto riguarda il valore atteso per la durata dell'impulso, possiamo
confrontare i due valori trovati per il tempo ``alto'' con il valore atteso
di Time-over-Threshold
\[
ToT = R_1 C_F \log\left(\frac{C_T}{C_F} \frac{2 V_s}{V\ped{thr}}\right) =
370 \pm 15 \; \si{\micro\s}
\]

Che risulta compatibile con quanto abbiamo trovato sperimentalmente entro 1 barra di errore.

\subsection{Andamento di TOT al variare di $Q\ped{in}$}
Provando con varie ampiezze del segnale in ingresso $V_s$, il comportamento
osservato per i due circuiti è essenzialmente lo stesso: per ampiezze maggiori
dei $\SI{50}{m\V}$ non sono presenti particolari deformazioni nel segnale
in uscita rispetto all'impulso atteso in uscita dal comparatore;
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{shaper_discrzoom}
\caption{Acquisizione del segnale in uscita dal circuito discriminatore con
un'onda quadra in ingresso $V_s = \SI{1}{\V}$, $f = \SI{100}{\Hz}$
\label{fig: shaperdiscr}}
\end{figure}

Riducendo l'ampiezza al di sotto dei $\SI{50}{m\V}$ il segnale in uscita
inizia a deformarsi, assumendo la forma di una parabola con concavità rivolta
verso il basso, la cui tensione massima raggiunta diminuisce in maniera
proporzionale all'ampiezza in ingresso.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{discr_sat}
\caption{Acquisizione del segnale in uscita dal circuito discriminatore con
un'onda quadra in ingresso $V_s = \SI{30}{m\V}$, $f = \SI{100}{\Hz}$
\label{fig: discr_sat}}
\end{figure}

Questo comportamento si osserva fino a circa $\SI{20}{m\V}$, quando il segnale
in uscita dal comparatore non è più apprezzabilmente diverso dalla tensione di
saturazione del trigger.

Il fronte di salita all'uscita del discriminatore è sicuramente limitato dallo
slew rate finito dell'amplificatore, per cui effettivamente ci aspettiamo
un tempo di salita dell'impulso in ingresso dell'ordine dei
\[
t_{oh} = V\ped{disc}^{pp}/SR = 7.9 / 13 = 2 \; \si{\micro\s}
\]

Mentre il fronte di discesa è meno ripido perché corrisponde alla transizione
del discriminatore sulla discesa esponenziale di $V\ped{sh} (t)$, che ha una
derivata ``piccola'' in prossimità della soglia. Questo infatti lascia
presumere che esista un intervallo temporale durante il quale l'uscita di
$V\ped{discr} (t)$ è in regime lineare.

A testimonianza di questa possibile transizione al regime lineare abbiamo
studiato la forma del segnale in uscita, per ampiezze dell'onda quadra
prossime alla soglia.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{shdiscthr}
\caption{Acquisizione del segnale in uscita dal circuito discriminatore con
un'onda quadra in ingresso $V_s = \SI{20}{m\V}$, $f = \SI{100}{\Hz}$
\label{fig: discrthr}}
\end{figure}
In cui è possibile riconoscere il transiente in uscita dallo shaper visto in
\ref{fig: shzoom} amplificato dal secondo OpAmp in regime lineare.

\subsection{Minima ampiezza di carica per cui si attiva il comparatore}
Per ottenere una misura di ampiezza minima di carica per cui si registra un
segnale che raggiunga la soglia $V_{OH}$ in uscita dal discriminatore abbiamo
variato l'ampiezza del segnale in ingresso $V_s$ dal generatore di forme
d'onda, dunque abbiamo misurato con i cursori l'ampiezza critica trovata per
i due circuiti studiati:
\begin{align*}
V\ped{min} &= 40.5 \pm 0.3 \; \si{m\V} \\ 
V'\ped{min} &= 43.6 \pm 0.4 \; \si{m\V}
\end{align*}
che corrispondono alle quantità di carica minima per gli amplificatori di
$Q\ped{min} = C_T \cdot 2V\ped{min} =
\{80, \; 87\} \pm  3 \; \si{\pico\coulomb}$.

\subsection{Confronto con i valori attesi}
Abbiamo eseguito un fit con legge logaritmica per l'andamento delle misure
del Time-over-Threshold al variare dell'ampiezza di carica in ingresso
$Q\ped{in}$, di cui riportiamo i risultati
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.7]{logfit}
    \caption{Fit logaritmico del $ToT$ in funzione dell'ampiezza di carica in
    ingresso $Q\ped{in}$ \label{fig: logfit}}
\end{figure}
\begin{align*}
V\ped{thr} &= 40.7 \pm 0.2 \; \si{m\V}
&\tau = 106.51 \pm 0.3 \; \si{\micro\s} \\
\chi^2/\mathrm{ndof} &= 0.6/8 &\mathrm{cov_{norm}} = 0.82
\end{align*}

Ritroviamo che il valore del tempo di smorzamento $\tau$ è compatibile con il
valore atteso dai componenti del circuito.
e che la tensione di soglia trovata dal fit è compatibile con il valore di
ampiezza del segnale in ingresso $V\ped{min}$ corrispondente alla minima
ampiezza di carica del punto precedente.

%=======================
\section{Trigger di Schmitt}
Abbiamo costruito un trigger di Schmitt a partire dall'OpAmp TL081CP
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=1.5]{trgSchmitt}
    \caption{Schema circuitale del trigger di Schmitt costruito.
    \label{fig: trgschmittschm}}
\end{figure}

\subsection{Risposta ad un'onda sinusoidale}
Abbiamo inviato all'ingresso invertente dell'OpAmp un'onda sinusoidale di
ampiezza $V_s = 999 \pm 8 \si{m\V}$ e frequenza $f = 100.0 \pm 1.6 \si{\Hz}$.
Si osserva immediatamente che né le due tensioni di saturazione, né tantomeno
le tensioni di soglia sono uguali in valore assoluto. \`E per questo motivo
che l'onda quadra in uscita dal trigger ha una componente continua positiva,
quindi la sua traccia visualizzata all'oscilloscopio risulta traslata verso
l'alto.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{schmitt}
\caption{Risposta del trigger di Schmitt ad un segnale sinusoidale di ampiezza
$V_s = \SI{1}{V}$ e frequenza $f = \SI{100}{Hz}$. \label{fig: schmittsine}}
\end{figure}

La stessa asimmetria si riscontra nel grafico XY dei segnali in ingresso e
uscita dal circuito, in cui le 2 rette di transizione verticali corrispondono
ai valori delle tensioni di soglia $V_{TL}$ e $V_{TH}$ del trigger. Queste
non sono simmetriche rispetto a $\SI{0}{V}$, ma risultano traslate verso
destra.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.4]{shmitt_isteresi}
\caption{Visualizzazione XY del seno di ampiezza $V_s = \SI{2}{\V}$ e
frequenza $\SI{100}{\Hz}$ in ingresso e del segnale in uscita dal trigger di
Schmitt. \label{fig: schmittxy}}
\end{figure}

\subsection{Saturazione dell'OpAmp}
Abbiamo misurato le tensioni di saturazione dell'OpAmp direttamente
dai valori alto $V_{OH}$ e basso $V_{OL}$ -pressoché costanti- che assume
l'onda quadra in uscita dal trigger tramite i cursori:
\begin{align*}
V_{OH} &= 4.28 \pm 0.04 \; \si{\V} \\
V_{OL} &= -3.66 \pm 0.03 \; \si{\V}
\end{align*}
Per il secondo circuito abbiamo trovato, allo stesso modo
\begin{align*}
V_{OH} &= 4.21 \pm 0.04 \; \si{\V} \\
V_{OL} &= -3.53 \pm 0.03 \; \si{\V}
\end{align*}

\subsection{Tensioni di soglia e funzionamento del trigger}
Ora abbiamo inviato in ingresso al circuito (nonché all'ingresso invertente
dell'OpAmp) un'onda sinusoidale di ampiezza
$1999 \pm 15 \; \si{m\V}$ e frequenza fissata a $1000 \pm 16 \; \si{\Hz}$.

Dalle intersezioni tra i canali in ingresso ed uscita abbiamo misurato le
tensioni per cui si verificano le transizioni basso-alto $V_{TH}$ e alto-basso
$V_{TL}$ nel primo trigger
\begin{align*}
V_{TH} &= -617 \pm 5 \; \si{m\V} \\
V_{TL} &= 775 \pm 6 \; \si{m\V}
\end{align*}
Per il secondo circuito invece abbiamo preso una media pesata dei punti che
giacciono sulle 2 linee verticali che si formano nelle transizioni del ciclo
di isteresi visto nel grafico XY di \cref{fig: schmittxy}.
\begin{align*}
V_{TH} &= -611.6 \pm 0.5 \; \si{m\V} \\
V_{TL} &= 780.4 \pm 0.5 \; \si{m\V}
\end{align*}

Supponiamo che l'OpAmp si comporti come il comparatore/discriminatore già
visto nell'amplificatore di carica, quindi che la differenza
$v_d = v_+ - v_- $ sia abbastanza grande da far sì che si trovi sempre in
regime non lineare. In piena analogia con quanto discusso nella
\cref{sub: discr}, come segnale in uscita dal comparatore ci aspettiamo
\[
V\ped{out} = V_{CC} \sgn(v_+ - v_-)
.\]
Inoltre, dal momento che l'ingresso non-invertente è collegato all'uscita del
partitore di tensione costituito da $R_1$ e $R_2$, abbiamo
\[
v_+ = \frac{R_2}{R_1 + R_2} V \ped{out} = \beta V\ped{out}
\]
dove abbiamo implicitamente definito il coefficiente di partizione
$\beta \coloneqq \frac{R_2}{R_1 + R_2}$. Quindi mettendo tutto insieme
\[
V\ped{out} = V_{CC} \sgn(\beta V\ped{out} - V_s)
.\]

Da cui vediamo che la tensione in uscita dal comparatore sarà al livello
``alto'' (cioè $V\ped{out} = V_{CC}$ nel semipiano
$V\ped{out} > V_s/\beta$ e ``basso'' (cioè $V\ped{out} = -V_{CC}$)
nel semipiano $V\ped{out} < V_s/\beta$. Queste condizioni definiscono la
tensione di soglia per cui ci aspettiamo avvengano le transizioni:
$V_s = \pm V\ped{trn}$, cioé
\begin{align}
V\ped{trn} = \beta V_{CC} = \frac{V_{CC}}{1 + R_1/R_2} = 0.90 \pm 0.03 \; \si{\V}
\end{align}

Possiamo spiegare il funzionamento del trigger di Schmitt in termini di
feedback positivo, che ne regola il comportamento tramite il controllo del
segnale in ingresso. Se la tensione $V_s$ è minore di $V_{TH} < \SI{0}{\V}$
il segnale in uscita rimane alto. Al crescere della tensione del segnale
in ingresso fino al valore di soglia
$V_s \geq V_{TL} \implies V\ped{out} \mapsto -V_{CC}$ il segnale in uscita
dal circuito salta repentinamente dal livello alto a basso. Dunque
$V\ped{out}$ rimane stabilmente basso fintanto che la tensione in ingresso
non diminuisce al di sotto della soglia opposta
$V_s \leq V_{TH} \implies V\ped{out} \mapsto V_{CC}$, per cui il segnale in
uscita sale velocemente al livello alto.

Il che corrisponde esattamente a quanto si riesce ad osservare visualizzando
i segnali in ingresso ed uscita con l'oscilloscopio in \cref{fig: schmittsine}.

\subsection{Limiti fisici del circuito}

\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{bodeschmitt1V100Hz5MHz}
\caption{Analisi in frequenza del trigger di Schmitt, con ampiezza del segnale
in ingresso fissata ad $\SI{1}{V}$, l'unico punto di interesse si trova a
circa $\SI{90}{k\Hz}$, frequenza oltre alla quale il circuito non ha più
il comportamento atteso.}
\end{figure}

Si osserva che il circuito si comporta come discriminatore con isteresi per
frequenze sufficientemente basse. Per frequenze maggiori di
$\sim\SI{10}{\kilo\hertz}$ la pendenza della transizione del segnale in
uscita da ``alto'' a ``basso'' e viceversa comincia ad essere limitata dallo
slew rate dell'OpAmp.
\[
\mathrm{SR} = 11.1 \pm 0.3 \; \si{V/\micro\s}
\]
Esiste quindi una frequenza limite, oltre il quale il trigger smette di funzionare: il valore di questa frequenza limite dipende anche dall'ampiezza dell'onda che si va ad utilizzare, per esempio nel caso in cui l'ampiezza dell'onda sia 1V la $F_L \approx 90 \si{k\Hz}$, nel caso invece di 2V la $F_L \approx 500 \si{k\Hz}$.
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.335]{bodeschmitt2V100Hz5MHz}
\caption{analisi in frequenza del trigger di schmitt, 2V di ampiezza, in particolare l'unico punto di interesse si trova a circa 3 MHz, punto in cui smette di funzionare}
\end{figure}
Il regime in cui l'OpAmp si comporta da discriminatore con isteresi è quello
in cui il tempo minimo di salita e discesa è molto minore del periodo del
segnale in ingresso (e in uscita)
\begin{equation}\label{eq:slewlimit}
T \gg 2 t \ped{min} \qquad t \ped{min} = \frac{V\ped{out}}{\mathrm{SR}} \approx \SI{0.5}{\micro\second} \implies f \ll \SI{1}{M\hertz}.
\end{equation}
che dimostra quanto abbiamo trovato sperimentalmente.

Variando l'ampiezza del segnale in igresso $V_s$ si osserva che l'ampiezza del
segnale in uscita rimane pressoché uguale fino a una soglia inferiore, al di
sotto della quale l'uscita diventa costante. 
Infatti, affinché ciò non accada il circuito deve poter compiere il ciclo di
isteresi, e dunque l'ampiezza picco-picco del segnale in ingresso deve essere
maggiore della base del rettangolo di isteresi:
\[ V_s > 2 V \ped{sat} \eqqcolon V\ped{s, min}. \]
Sperimentalmente si può misurare dal valore delle soglie, prendendo come ampiezza la soglia più lontana dallo zero.
Nonostante questo, un cambio nell'ampiezza dell'onda in ingresso provoca un mutamento del duty cycle del circuito: in particolare per valori molto vicini alla soglia il duty cycle risulta $\approx 60 \%$, mentre per valori più alti, come ad esempio $\approx 5 \si{V}$ si registra un $DC =50.6 \pm 1.1 \; \%$

%=======================
\section{Multivibratore astabile}

\begin{figure}[htbp]
    \centering
	\includegraphics[scale=1.5]{astable}
    \caption{Schema circuitale del multivibratore astabile costruito.
    \label{fig: astableschm}}
\end{figure}

\subsection{Funzionamento del circuito}
Il circuito in figura \ref{fig: astableschm} funziona come un trigger di
Schmitt collegato in input ad un filtro passa-basso RC. Il condensatore $C_1$ si
carica fino a raggiungere il livello della tensione dell’ingresso non
invertente, a questo punto l’OpAmp scatta, la tensione nell’ingresso non invertente
scende e il condensatore comincia a scaricarsi fino a quando il livello della
tensione ai capi del condensatore non raggiunge quello presente all’ingresso
non invertente.
Il ciclo dunque si ripete generando un'onda quadra il cui periodo di
oscillazione è quindi il doppio del tempo caratteristico $\tau$ in
cui il condensatore è in grado di caricarsi/scaricarsi.


\[ 
V_{OH}=4.18 \pm 0.04 \si{\V}
\]
\[
V_{OL}=-3.47 \pm 0.03 \si{\V}
\]

Dette
\begin{align*}
q &= \frac{R_1}{R_1 + R_2} = 0.502 \pm 0.006 \\
\tau &= R_3 C_1 = 101 \pm 4 \; \si{\micro\s}
\end{align*}
Abbiamo come valori attesi per i tempi caratteristici alto $t_H$ e basso
$t_L$ ed il periodo $T$ dell'onda quadra generata dal multivibratore:
\begin{align}
t_H &= \tau \ln\left(\frac{1 - q\frac{V_{OL}}{V_{OH}}}{1-q}\right) = 1.04 \pm 0.04 ms\\
t_L &= \tau \ln\left(\frac{1 - q\frac{V_{OH}}{V_{OL}}}{1-q}\right) = 1.16 \pm 0.05 ms\\
\end{align}
Conseguentemente il valore del periodo e duty cycle atteso valgono:
\begin{align}
T = t_H + t_L = 2.2 \pm 0.09 \si{m\s} \;
DC = \frac{t_H}{T}=47.2 \pm 2.6 \; \%
\end{align}

\setcounter{subsection}{2}
\subsection{Studio dei segnali in ingresso e uscita}

\begin{figure}[htbp]
\centering
\includegraphics[scale=0.4]{V+Vout}
\caption{Grafico segnale in $V_+$ e segnale in $V_{out}$}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[scale=0.4]{V-Vout}
\caption{Grafico segnale in $V_-$ e segnale in $V_{out}$}
\end{figure}

Osservando il segnale in uscita Vout ci si aspetta di osservare un’onda quadra
di ampiezza picco-picco $\approx \SI{8}{\V}$ e periodo $2.15 \pm 0.03 \; \si{m\s}$ e
duty cycle $50 \%$.
Osservando $V_+$ ci si aspetta un segnale identico a $V\ped{out}$, ma ridotto di
un fattore $\beta \approx 0.5$.
Osservando $V_-$, infine, ci si aspetta di vedere un segnale ``a pinna di
squalo'', caratteristico del processo di carica/scarica di un condensatore,
con la stessa ampiezza picco-picco di $V_+$.

\subsection{Misure di periodo e duty cycle}
Per misurare i periodi alti e bassi e duty cycle abbiamo utilizzato i cursori sull'asse x per misurare il tempo in cui l'onda quadra era in saturazione positiva (o negativa) e il tempo di 8 periodi d'onda per ricavare il periodo
Abbiamo poi misurato i valori:
\begin{align}
t_H &=1.03 \pm 0.02 ms \\
t_L &=1.12 \pm 0.02 ms\\
T &=2.14 \pm 0.01 ms\\
\end{align}
\[
DC = \frac{t_H}{T}=47.9 \pm 1.0 \; \si{\%}
\]
Dato che le misure dei tempi in saturazione positiva e negativa e del periodo sono perfettamente compatibili entro una barra di errore dal valore atteso, ne deduco che lo sia anche il duty cycle

\subsection{Limite massimo in frequenza del generatore}
Riducendo di metà il valore della resistenza $R_3$ o riducendo di metà il
valore della capacità $C_1$ notiamo un raddoppiamento della frequenza
del treno d'impulsi generato dovuto ad un dimezzamento del tempo
caratteristico di carica/scarica $\tau=R_3 C_1$.

Quando il valore del semi periodo diventa dell'ordine del $\si{\micro\s}$, il
tempo che lo slew rate impiega per fare un salto di circa $8$V, non
otteniamo più in uscita un'onda quadra perché l'OpAmp non riesce a passare
in tempo da uno stato all'altro.

Dato che $SR=11.1 \pm 0.3 \si{V/s}$ e che il salto tra $SAT_-$ e $SAT_+$ corrisponde circa a $8$V il periodo dell'onda deve valere come minimo $T_{min}\approx 1.5 \si{\micro\s}$ quindi $\tau=R_3 C_1$ deve essere $ >> T_{min}$
%=======================
\section{Multivibratore monostabile}
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=1.2]{monostable}
    \caption{Schema circuitale del multivibratore monostabile costruito.
    \label{fig: monostableschm}}
\end{figure}

\subsection{Studio dei segnali in ingresso e uscita}
\begin{figure}[htbp]
\centering
\includegraphics[scale=0.42]{monostabile}
\caption{Grafico segnale in ingresso e $V_{out}$ \label{fig: vout_mstabile}}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[scale=0.42]{monostabileV+}
\caption{Grafico segnale in $V_+$ e $V_{out}$}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[scale=0.42]{monostabileV-}
\caption{Grafico segnale in $V_-$ e $V_{out}$ \label{fig: monostabileV-}}
\end{figure}

I segnali osservati riproducono qualitativamente quanto atteso.
In particolare, per $ V \ped{out} $ si osserva un'onda quadra con duty cycle,
per $ V_{-} $ un segnale analogo a $ V\ped{out} $ ma ridotto di un fattore
$\frac{R_2}{R_2 + R_1} \simeq 0.5 $.

Si è misurato il tempo per cui il segnale $ V \ped{out} $ rimane ``basso'' in ogni periodo:

Il valore atteso è
\begin{equation} \label{eq: mstabile}
t\ped{L, exp} =
\tau \log\left[\left(1 + \frac{V_\gamma}{V \ped{out}/2}\right)
\left(1 + \frac{R_2}{R_1}\right)\right]
\end{equation}
riportato senza incertezza data la natura nominale e indicativa del parametro $ V_{\gamma} \simeq \SI{0.7}{\volt} $.

In assenza del sotto-circuito di trigger, il sistema presenta un solo stato stabile in cui $ V\ped{out} =  V_{\gamma} + V_{z} $.
Come nel caso del multivibratore astabile, $ V\ped{out} $ può assumere solo come valori $ \pm V_{\gamma} + V_{z} $.
Se il condensatore è inizialmente scarico e se è $ V\ped{out} = V_{\gamma} + V_{z} $ allora il condensatore $ C $ si carica fino a quando la caduta ai suoi capi è $ V_{\gamma} $ essendo in parallelo ad un diodo; essendo quindi $ V\ped{+} \sim V_{\gamma} \simeq \SI{0.7}{\volt} $ e $ V_{-} = \frac{R_{2}}{R_{1} + R_{2}} V\ped{out} \simeq 0.5 \times \SI{7}{\volt} = \SI{3.5}{\volt} $, l'uscita rimane ``alta''.
Se il condensatore è inizialmente carico (con caduta ai capi pari a $ V_{\gamma} $) e se è $ V\ped{out} = -(V_{\gamma} + V_{z}) $, allora si scarica fintanto che è $ V_{-} > V_{+} \simeq -\SI{3.5}{\volt} $: a questo, essendo l'OpAmp in regime di saturazione, l'uscita passa a $ V\ped{out} = V_{\gamma} + V_{z} $ e il condensatore si carica come descritto sopra, ripristinando la condizione $ V_{+} \sim V_{\gamma} $. \\

Il sotto-circuito di trigger, formato dal passa-alto con il diodo in cascata, ha la funzione di ``sovrapporre'' a $ V_{+} $ dei picchi di differenza di potenziale negativa che portano il circuito nella configurazione instabile sopra descritta, che, dopo un tempo caratteristico dato dall'equazione~\eqref{eq: mstabile} torna nella configurazione stabile. \\

Come si può vedere in figura~\ref{fig: vout_mstabile}, quanto osservato 
sperimentalmente riproduce qualitativamente l'andamento atteso dall'analisi
teorica del circuito.

\subsection{Durata dell'impulso generato}
Mi aspetto di trovare una durata dell'impulso pari a $\Delta= R_3 C_1 \ln(\frac{1 - \frac{V_\gamma}{V_{OL}}}{1 - \beta})$
Misurando coi cursori la tensione di saturazione negativa ottengo e il $V_\gamma$ come la retta orizzontale che viene formata in V- come si vede in figura ~\ref{fig: monostabileV-}:
\[
V_{OL}= -3.49 \pm 0.03 \si{\V}
\]
\[
V_{\gamma}= 549 \pm 6 \si{m\V}
\]



quindi $\Delta= 0.83 \pm 0.03 \si{\micro\s}$.

Dalla misura diretta ricavo
\[
\Delta= 784 \pm 10 \;\si{\micro\s}
\]
che risulta distante più di una barra di errore dal valore aspettato
\subsection{Analisi del funzionamento del circuito}
a discesa di $ V\ped{trig} $ causa l'impulso in $ V\ped{out} $. La risalita in $ V\ped{out} $ accade quando $ V\ped{trig} $ è costante, prima che torni ``alto''. Tale risalita avviene infatti nel momento in cui $ V_{-} $ assume il valore minimo che fa ``scattare'' il discriminatore.

Si tiene fissa l'ampiezza di $ V\ped{trig} $ e se ne varia la frequenza. Si osserva che la durata dell'impulso in $ V \ped{out} $ risulta (entro gli errori di misura) indipendente dalla frequenza del segnale in ingresso, fino a quando la durata di tale impulso è minore del periodo di $ V\ped{trig} $. Al di sopra di tale frequenza critica (sperimentalmente $ f \sim \SI{974}{\hertz} $) il circuito smette di funzionare correttamente.

Si tiene la frequenza di $ V\ped{trig} $ e se ne varia l'ampiezza. La durata dell'impulso in $ V\ped{out} $ risulta (entro gli errori di misura) indipendente dall'ampiezza del segnale in ingresso fintanto $ V\ped{trig} $ è maggiore di una certa soglia. Si osserva sperimentalmente che al di sotto di $ V\ped{trig} \sim \SI{3.7}{\volt} $ il circuito rimane nella configurazione stabile. Infatti se $ V\ped{trig} $ è minore di una certa soglia ci aspettiamo che $ V_{+} $, dato dalla sovrapposizione dell'impulso prodotto dal sotto-circuito di trigger e del segnale uscente dal partitore, non sia abbastanza grande da rendere $ V_{+} - V_{-} $ negativo e far scattare il discriminatore.


%=======================
\section*{Conclusioni e commenti finali}
Si è riusciti a costruire e studiare alcuni dei circuiti più comuni che si
possono realizzare con un amplificatore operazionale, tra cui: due filtri
attivi, passa-basso e passa-alto, un amplificatore di tensione invertente
(e uno non).
In particolare siamo riusciti ad apprezzare il differente comportamento dei
circuiti (anche in regime non lineare) dare una stima di guadagno, impedenza di
ingresso e frequenze caratteristiche della loro risposta in frequenza.

%=======================
\section*{Dichiarazione}
I firmatari di questa relazione dichiarano che il contenuto della relazione \`e
originale, con misure effettuate dai membri del gruppo, e che tutti i firmatari
hanno contribuito alla elaborazione della relazione stessa.

\newpage
\subsection*{Appendice}
Consideriamo il sotto-circuito formato dal condensatore $C_T$ e dal circuito
di formazione. La funzione di trasferimento che lega $V_s$ a $V\ped{sh}$ è
data di fatto da quella di un amplificatore invertente con impedenze
complesse: in trasformata di Laplace
\[
\tilde{A}(s) = - \frac{\left(\frac{1}{R_1} + s 
C_F\right)^{-1}}{\frac{1}{s C_T}} = - \frac{C_T}{C_F} 
\frac{s}{s + \frac{1}{\tau}}
\]
con $ \tau \coloneqq R_1 C_F $. In ingresso abbiamo un'onda quadra di 
periodo $ 2T $ (che prendiamo nulla per tempi negativi) che possiamo scrivere 
come
\[
V\ped{in}(t) = \sum_{k=0}^{+\infty} (-1)^{k}f(t - kT)
\qquad \text{dove} \quad
f(t) = V_s \left[\theta(t) - \theta(t - T)\right]
\]
In trasformata di Laplace si ha
\[
\tilde{f}(s) = V_s\left[\frac{1}{s} - \frac{e^{-sT}}{s}\right]
\]
da cui
\[
\tilde{V}\ped{in}(s) = \sum_{k=0}^{+\infty} (-1)^{k} \tilde{f}(s) e^{-kTs} = 
\tilde{f}(s) \sum_{k=0}^{+\infty} (-1)^{k} e^{-kTs}
\]
La risposta del circuito in trasformata è
\[
  \tilde{V}\ped{sh}(s) = \tilde{A}(s) \tilde{V}\ped{in}(s) =  
\tilde{A}(s)\tilde{f}(s) \sum_{k=0}^{+\infty} (-1)^{k}e^{-kTs} = \tilde{g}(s) 
\sum_{k=0}^{+\infty} (-1)^{k}e^{-kTs} = \mathcal{L}\left[\sum_{k=0}^{+\infty} 
(-1)^{k}g(t - kT)\right](s)
\]
Ora
\[
  \tilde{g}(s) = - V_s \frac{C_T}{C_F} \left[\frac{1}{s + 
\frac{1}{\tau}} - \frac{e^{-sT}}{s + \frac{1}{\tau}}\right]
\]
da cui, anti-trasformando
\[
  g(t) = - V_s \frac{C_T}{C_F} \left[e^{-t/\tau}\theta(t) - 
e^{-(t-T)/\tau} \theta(t - T) \right]
\]

Ma allora la risposta del circuito nel dominio del tempo è
\begin{align*}
  V\ped{sh}(t) &= - V_s \frac{C_T}{C_F} \left\{ 
\sum_{k=0}^{+\infty} (-1)^{k}e^{-\frac{t - kT}{\tau}}\theta(t - kT) - 
\sum_{k=0}^{+\infty} (-1)^{k} e^{-\frac{t- (k+1) T }{\tau}} \theta(t - (k+1)T ) 
\right\} \\
               &= - V_s \frac{C_T}{C_F} \left\{ e^{-\frac{t}{\tau}} 
\theta(t) - 2 \sum_{k=1}^{+\infty} (-1)^{k} e^{-\frac{t - kT}{\tau}} \theta(t - 
kT) \right\}
\end{align*}
ovvero, ignorando il transiente iniziale e supponendo $ \tau\ll T $\footnote{
La buona definizione della somma è assicurata dal fatto che (tralasciando le 
costanti fisiche)
\[ \sum_{k \geq 0} \theta(t-k) e^{-(t-k)} = \sum_{k=0}^{\lfloor t \rfloor} 
e^{-(t-k)} \leq \frac{e}{e-1} e^{-\{t\}}. \]
},
\begin{align}\label{eq:Vshaper}
V\ped{sh}(t) &\approx 2 V_s \frac{C_T}{C_F} \sum_{k=1}^{+\infty} 
(-1)^{k} e^{-\frac{t - kT}{\tau}} \theta(t - kT) \nonumber\\
               &\approx  2 V_s \frac{C_T}{C_F} \sum_{k=1}^{+\infty} 
(-1)^{k} e^{-\frac{t - kT}{\tau}} \chi_{[kT, (k+1)T]}(t)
\end{align}

\end{document}
