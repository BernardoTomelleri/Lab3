\documentclass[10pt, a4paper, italian]{article}
\input{../../latex/preamble}
\input{../../latex/math}
\geometry{left=2cm, right=2cm, top=2cm, bottom=2cm}

% lets graphicx know path where figures to be included are found
\graphicspath{{../figs/}}

\author{Gruppo 1.AC \\ Matteo Rossi, Bernardo Tomelleri}
\title{Es07A: Controllore Proporzionale-Integrale}
\begin{document}
\date{\today}
\maketitle

\section{Misura componenti dei circuiti}
\begin{table}[htbp]
\centering
\begin{tabular}{cccccc}
\toprule
Resistenze $[\si{\ohm}]$ & $R$ & $\sigma R$ & Capacità $[\si{n\F}]$ & $C$ &
$\sigma C$ \\
\midrule
\midrule
$R_1$	  	& 992 	& 8		& $C_1$ & 212	& 9 \\
$R_2$	  	& 992	& 8		& & & \\
$R_4$	  	& 991	& 8		& & & \\
$R_5$	  	& 9.96 k	& 0.08	k& & & \\
$R_6$	  	& 99.9 k	& 0.8	k& & & \\
$R_7$	  	& 9.96 k& 0.08	k	& & & \\
$R_8$	  	& 104.6	k& 8		k& & & \\
$R_9$	  	& 103.0	k& 0.8	k	& & & \\
$R_{10}$  	& 100.6	k& 8		k& & & \\
$R_{11}$  	& 1.911	& 8		& & & \\
\bottomrule     
\end{tabular}
\caption{Valori di resistenza e capacità misurate per i componenti dei
circuiti studiati. \label{tab: rcmes_B}}

\begin{tabular}{cccccc}
\toprule
Resistenze $[\si{\ohm}]$ & $R$ & $\sigma R$ & Capacità $[\si{n\F}]$ & $C$ &
$\sigma C$ \\
\midrule
\midrule
$R_1$	  	& 996 	& 8		& $C_1$ & 207	& 9 \\
$R_2$	  	& 994	& 8		& & & \\
$R_4$	  	& 999	& 8		& & & \\
$R_5$	  	& 9.95	k& 0.08	k& & & \\
$R_6$	  	& 99.1	k& 0.8	k& & & \\
$R_7$	  	& 9.96	k& 0.08		k& & & \\
$R_8$	  	& 99.6	k& 0.8		k& & & \\
$R_{10}$  	& 99.8	k& 0.8		k& & & \\
$Pot_{R_9}$ & 103.4 k & 0.8 k& & & \\
$Pot_{R_{11}}$ & 1.99 k & 0.08 k& & &\\
\bottomrule   
\end{tabular}
\caption{Valori di resistenza e capacità misurate per i componenti dei
circuiti studiati. \label{tab: rcmes_M}}
\end{table}

Riportiamo per completezza anche i valori delle tensioni di alimentazione
continue per l'op-amp misurate con il multimetro
\begin{align*}
V_{CC} &= 4.99 \pm 0.03 \si{\V} \\
V_{EE} &= -4.99 \pm 0.03 \si{\V}
\end{align*}

\subsection{Nota sul metodo di fit}
Per determinare i parametri ottimali e le rispettive covarianze si \`e
implementato in \verb+Python+ un algoritmo di fit basato sui minimi quadrati
mediante la funzione \emph{curve\_fit} della libreria \texttt{SciPy}.

%=======================
\setcounter{section}{2}
\section{Generatori di luce e circuito di lettura}
Il primo passo per la costruzione del circuito P.I.D. è la realizzazione del
circuito di lettura. Nel nostro caso abbiamo realizzato un sistema di
rilevazione di intensità luminosa costituito da due circuiti identici che
emettono luce grazie a due LED bianchi (uno per il disturbo e l'altro di
controllo) e da un partitore di tensione dato dalla serie di una resistenza
$R_3$ e una fotoresistenza $R_4$.

\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.7]{noisegen}
    \caption{Schema dei circuiti di emissione e rilevazione di intensità
    luminosa.
    \label{schm: mesctrl}}
\end{figure}

\subsection{Analisi del funzionamento del circuito}
La fotoresistenza è una resistenza variabile in funzione dell'intensità
luminosa che incide su di essa. In particolare sappiamo che il valore di
resistenza $R_4$ e intensità della luce incidente sulla superficie della
fotoresistenza sono inversamente proporzionali.

Dalla formula del partitore di tensione sappiamo che il valore dell'uscita
\verb+MEAS+ dev'essere pari a
\begin{equation}
V\ped{MEAS} = (V_{CC} -  V_{EE})\frac{R_4}{R_4 + R_3} + V_{EE}
\end{equation}
Ci aspettiamo allora che aumentando la luce (quindi nel nostro caso pilotando
l'ingresso del LED driver di disturbo con una rampa), il valore di
$V\ped{MEAS}$ andrà ad aumentare sempre entro l'intervallo di tensioni
$(V_{EE}, V_{CC})$.

Riportiamo una serie di misure di $V\ped{MEAS}$ al variare del valore della
tensione continua generata all'ingresso \verb+W2+.
\begin{table}[htbp]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
$V\ped{gen} [\si{\V}]$ & $V\ped{meas} [\si{\V}]$\\
\midrule
$-4.2 \pm 0.3$ m 	& $ -4.99 \pm 0.05$	\\
$995 \pm 7$ m 	& $ -2.11 \pm 0.02 $	\\
$1.99 \pm 0.02$ 	& $ -1.01 \pm 0.08 $\\
$2.98 \pm 0.04$ 	& $ -359 \pm 3 $ m\\
$3.98 \pm 0.04$ 	& $ 42.1 \pm 0.7 $ m\\
$4.98 \pm 0.05$ 	& $ 335 \pm 3$ m\\
\bottomrule
\end{tabular}
\caption{Misure di $V\ped{MEAS}$ in funzione della tensione in ingresso nel
LED driver di disturbo}
\end{table}
Come ci aspettavamo il valore di $V\ped{meas}$ cresce all'aumentare
dell'intensità della luce incidente sulla fotoresistenza, cioè aumentando la
tensione in ingresso $V\ped{gen}$.

Per evidenziare meglio l'andamento del segnale in uscita dal partitore
\verb+MEAS+ al variare della tensione del segnale di disturbo si è
'automatizzata' la procedura inviando una rampa/gradinata discreta generata
da \verb+W2+ tramite script definito in Wavegen.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{measgrad}
    \caption{Acquisizione presa dall'oscilloscopio dell'andamento nel tempo dei
	segnali in ingresso $W_2 (t)$ (CH1) e uscita $V\ped{MEAS} (t)$ (CH2)
	del partitore di tensione con \texttt{CONTROL} collegato a massa.
    \label{fig: errmeas}}
\end{figure}

%=======================
\section{Amplificatore di Noise rispetto a Set}
Si è costruito un amplificatore differenziale con guadagno $\sim 10$ a
partire dalle resistenze $R_5$, $R_6$ e $R_7$, $R_8$ secondo lo schema in
figura.
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.8]{errorgen}
    \caption{Schema circuitale dell'amplificatore differenziale realizzato
    \label{schm: errgen}}
\end{figure}
Lo scopo del circuito è quello di amplificare la differenza tra i segnali
$V\ped{SET}$ e $V\ped{MEAS}$ di un fattore 10.
Si è quindi misurato il guadagno per entrambi gli ingressi dell'OpAmp,
inviando un segnale a uno e collegando l'altro a massa. Ci si aspetta che nel
caso in cui SET sia collegato al segnale in ingresso, l'uscita dev'essere
invertita, mentre nel caso opposto MEAS e ERROR devono essere in fase.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{error.set}
    \caption{Acquisizione presa dall'oscilloscopio dell'andamento nel tempo dei
	segnali in ingresso $V\ped{SET} (t)$ (CH1) e uscita $V\ped{ERROR} (t)$ (CH2)
	dall'amplificatore differenziale con \texttt{MEAS} collegato a massa.
    \label{fig: errset}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{error.meas}
    \caption{Acquisizione presa dall'oscilloscopio dell'andamento nel tempo dei
	segnali in ingresso $V\ped{MEAS} (t)$ (CH1) e uscita $V\ped{ERROR} (t)$ (CH2)
	dall'amplificatore differenziale con \texttt{SET} collegato a massa.
    \label{fig: errmeas}}
\end{figure}

Abbiamo quindi misurato il guadagno per i due ingressi dell'OpAmp definito
come $A = \frac{V\ped{ERROR}}{V\ped{in}}$, da cui risulta
\begin{align*}
A\ped{SET} &= -10.01 \pm 0.14 \\
A\ped{MEAS} &= 10.01 \pm 0.14
\end{align*}

Per l'ingresso invertente \verb+SET+ e non-invertente \verb+MEAS+
rispettivamente, questi risultano compatibili con i valori di guadagno attesi
per l'amplificatore differenziale:
\begin{align*}
A\ped{SET} &= - \frac{R_8}{R_7} = -10.00 \pm 0.11 \\
A\ped{MEAS} &= \frac{R_6}{R_5} = 9.96 \pm 0.11
\end{align*}

Per controllare la tensione di riferimento si è poi costruito un circuito che
permettesse di variare $V\ped{SET}$ nello stesso intervallo
$(V_{EE}, V_{CC})$ attraverso l'uso di un potenziometro da
$R_{11} = 2 \si{k\ohm}$.
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.7]{setgen}
    \caption{Schema del circuito per la configurazione della tensione di
    riferimento.
    \label{schm: setgen}}
\end{figure}

Per verificare il corretto funzionamento del circuito amplificatore di
differenza tra i 2 segnali in ingresso, sappiamo che nel caso in cui
\verb+MEAS+ e \verb+SET+ siano uguali allora la differenza dev'essere nulla,
ovverosia in uscita dovremmo trovare $V\ped{ERROR} = 0$ V.
Difatti, collegando i terminali differenziali del CH1 dell'oscilloscopio
per misurare il segnale $V\ped{MEAS} (t)$ rispetto al segnale $V\ped{SET} (t)$
(registrando così la loro differenza) e CH2 per misurare $V\ped{ERROR} (t)$
all'uscita rispetto a massa troviamo che entrambi sono costanti e compatibili
con $\SI{0}{\V}$ come volevamo.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{meas.same.set}
    \caption{Stampa a schermo dell'oscilloscopio nella condizione in cui le
    tensioni in \texttt{SET} e \texttt{MEAS} sono uguali. Con il canale uno
    si misura la differenza di potenziale tra $V\ped{MEAS}$ e $V\ped{SET}$,
    con il canale due invece $V\ped{ERROR}$ rispetto a massa.
    \label{fig: meas=set}}
\end{figure}

%=======================
\section{Controllo integrale}
Successivamente si è montato il circuito di controllo integrale, cioè un
circuito integratore RC costituito dalla resistenza $R_9$ del potenziometro e
da una condensatore $C_1$, montati secondo lo schema in \cref{fig: ctrlint}.
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.6]{controlgenint}
    \caption{schema circuitale del controllore ad azione integrale.
    \label{fig: ctrlint}}
\end{figure}

\section{Verifica del funzionamento del circuito}
Abbiamo collegato l'uscita \verb+CONTROL+ al driver per la luce di
controllo e l'uscita del circuito di generazione errore all'entrata del
circuito di controllo integrale.
A questo punto è stato sufficiente passivare il generatore di luce di
disturbo e spostare il contatto strisciante di $R_9 = 100 \; \si{k\ohm}$ a
fine corsa per poter osservare l'accensione del LED di controllo.

Si nota immediatamente come la risposta del LED di controllo sia estremamente
sensibile alla quantità di luce che incide sulla fotoresistenza. Per questo
motivo abbiamo scelto di coprire il circuito e spostarci quanto meno possibile
durante le prese dati, al fine di schermare l'apparato sperimentale da
eventuali sorgenti di disturbo casuali (e.g. persone/cose che si spostano
in prossimità della fotoresistenza).

Si è riusciti a verificare la risposta del circuito con LED di controllo ad un
intervento esterno di riduzione della luce: si sono interposte delle buste di
plastica trasparenti tra il diodo e la fotoresistenza, dunque abbiamo
osservato il LED aumentare l'intensità luminosa in uscita di conseguenza.

\section{Risposta ad un'onda quadra}\label{sec: intsqwresp}
Si è quindi passati allo studio della risposta del circuito ad una luce di
disturbo, in questo primo caso pilotata da un'onda quadra.
Per prima cosa occorre fissare un valore di tensione di riferimento \verb+SET+:
si è scelta come intensità luminosa arbitraria quella che \verb+MEAS+ legge
quando uno dei 2 driver LED è pilotato con una tensione di $\SI{1}{\V}$.
Infine si è impostato il valore di resistenza del potenziometro $R_{11}$ in
modo tale che \verb+MEAS+ e \verb+SET+ si trovassero alla stessa tensione.

A questo punto si è inviata al LED driver di disturbo un'onda quadra compresa
tra $0$ e $150 \; \si{m\V}$ con frequenza pari a $f = 1 \si{\Hz}$.
Osservando l'andamento nel tempo dei segnali $V\ped{CONTROL} (t)$ e
$V\ped{MEAS} (t)$ si riesce ad apprezzare il comportamento del circuito sotto
studio; questo cerca di ``correggere'' il disturbo esterno al fine di
mantenere il valore dell'osservabile $V\ped{MEAS}$ costante nel tempo.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{control7.meas}
    \caption{Acquisizione all'oscilloscopio dell'andamento nel tempo dei
    segnali in \texttt{CONTROL} (CH1) e di \texttt{MEAS} (CH2) rispetto a
    massa.
    \label{fig: ctrlmeas}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{control7}
    \caption{Acquisizione all'oscilloscopio dei segnali $V\ped{CONTROL} (t)$
    (CH1) e dell'onda pilota del LED di disturbo $W_2 (t)$ (CH2).
    \label{fig: ctrlnoise}}
\end{figure}

Dunque abbiamo osservato il comportamento del segnale in \verb+error+ al
variare della resistenza del potenziometro $R_9$. Si nota che il segnale
ha un andamento `inversamente' proporzionale all'onda quadra di disturbo,
ovvero rimane costante durante i periodi alti e bassi, mentre in
corrispondenza dei fronti di discesa e salita di $W_2 (t)$ assume la forma di
un'oscillazione smorzata esponenzialmente. In altre parole $V\ped{ERROR} (t)$
è sempre un'onda quadra con overshoot in opposizione di fase all'onda quadra in
\verb+NOISE+, ma al variare della posizione del trimmer cambia sensibilmente
il tempo di smorzamento $\tau$ dopo il quale il segnale torna ad essere 0 una
volta che l'oscillazione si è spenta.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{7}
    \caption{Acquisizione presa dall'oscilloscopio dell'andamento dei segnali
    $V\ped{ERROR}$ (CH1) rispetto all'onda quadra $W_2 (t)$ di disturbo (CH2).
    \label{fig: errnoise}}
\end{figure}

Tramite cursori si è quindi misurato il tempo di smorzamento dell'overshoot e
lo abbiamo confrontato con il tempo caratteristico di risposta del circuito
integratore definito da $\tau\ped{RC} = R_9 C_1$.
\begin{table}[htbp]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
Resistenza $R_9$ $[\si{k\ohm}]$ & $\tau$ [ms] & $\tau\ped{RC}$ [ms] \\
\midrule
\midrule
$103.4 \pm 0.8 $ & $20.7 \pm 0.4$ & $ 21.4 \pm 0.9$ \\
$92.8 \pm 0.8$	& $19.0 \pm 0.3$ & $ 19.2 \pm 0.8 $ \\
$67.7 \pm 0.6$	& $15.3 \pm 0.3$ & $ 14.0 \pm 0.6 $ \\
$40.2 \pm 0.4$	& $8.2 \pm 0.2$ & $ 8.6 \pm 0.3 $ \\
$26.4 \pm 0.3$	& $5.8 \pm 0.1$ & $ 5.6 \pm 0.2 $ \\
$11.98 \pm 0.10$ & $2.72 \pm 0.10$ & $2.5 \pm 0.1$ \\
\\
$7.34 \pm 0.06$ & $3.24 \pm 0.10$ & $ 1.52 \pm 0.06$ \\
$2.78 \pm 0.03$ & $0.92 \pm 0.05$ & $ 0.59 \pm 0.02$ \\
\bottomrule
\end{tabular}
\caption{Misura dei tempi di smorzamento delle oscillazioni
di $V\ped{ERROR} (t)$ e confronto con tempo caratteristico di risposta
dell'integratore al variare di $R_9$.}
\end{table}

Da cui vediamo che le prime misure di tempo risultano compatibili con i loro
valori attesi, mentre per valori di resistenza $R_9 < \SI{10}{k\ohm}$ queste
tendono a discostarvisi sempre di più al diminuire del valore di resistenza.

\section{Risposta ad una rampa}
Come prima si è reimpostato il valore della resistenza del potenziometro al
massimo ($100 k\ohm$ nominali) ma stavolta si è pilotato il driver LED di
disturbo con un'onda triangolare compresa tra $0$ e $150 \si{m\V}$ di frequenza
$f = 10 \; \si{\Hz}$ e duty-cycle $\text{dc} = 10 \percent$, $90 \percent$.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{8}
    \caption{Acquisizione dall'oscilloscopio degli andamenti nel tempo dei
    segnali in \texttt{ERROR} (CH1) e del segnale di disturbo $W_2 (t)$
    con l'onda triangolare di duty-cycle $10 \percent$
    \label{fig: erramp10}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{8.1}
    \caption{Acquisizione dall'oscilloscopio degli andamenti nel tempo dei
    segnali in \texttt{ERROR} (CH1) e del segnale di disturbo $W_2 (t)$
    con l'onda triangolare di duty-cycle $10 \percent$.
    \label{fig: erramp90}}
\end{figure}




Anche in questo caso il circuito di amplificazione dell'errore si comporta quasi come un derivatore: in fin dei conti è quello che ci si aspetta, dato che il controllo deve integrare il segnale di errore, per poter bilanciare il cambiamento di luce, c'è bisogno che anche l'uscita del controllo sia un'onda triangolare simmetrica a quella con cui pilotiamo il LED di disturbo. Inoltre dato che il circuito integratore agisce in un tempo non trascurabile di fronte a dei cambiamenti,il segnale di errore non potrà mai essere nullo, infatti se lo fosse il controllore non produrrebbe alcun cambiamento, cosa che può sussistere solo nel caso in cui si abbia una luce di disturbo costante nel tempo.

\section{Risposta in frequenza}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{103.4k}
    \caption{Plot di Bode ottenuto dallo scan con Network tra $\SI{1}{\Hz}$ e
	$\SI{1}{k\Hz}$ con un segnale sinusoidale in ingresso al LED di disturbo di
	ampiezza $v\ped{in} = \SI{100}{m\V}$ e offset costante di $\SI{50}{m\V}$.
	In azzurro la risposta in frequenza del segnale in \texttt{ERROR} per un
	valore di resistenza del potenziometro $R_9 = 103.4 \pm 0.8 \; \si{k\ohm}$.
    \label{fig: netR103}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{76.1k}
    \caption{Plot di Bode ottenuto dallo scan con Network tra $\SI{1}{\Hz}$ e
	$\SI{1}{k\Hz}$ con un segnale sinusoidale in ingresso al LED di disturbo di
	ampiezza $v\ped{in} = \SI{100}{m\V}$ e offset costante di $\SI{50}{m\V}$.
	In azzurro la risposta in frequenza del segnale in \texttt{ERROR} per un
	valore di resistenza del potenziometro $R_9 = 76.1 \pm 0.6 \; \si{k\ohm}$.
    \label{fig: netR76}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{43.9k}
    \caption{Plot di Bode ottenuto dallo scan con Network tra $\SI{1}{\Hz}$ e
	$\SI{1}{k\Hz}$ con un segnale sinusoidale in ingresso al LED di disturbo di
	ampiezza $v\ped{in} = \SI{100}{m\V}$ e offset costante di $\SI{50}{m\V}$.
	In azzurro la risposta in frequenza del segnale in \texttt{ERROR} per un
	valore di resistenza del potenziometro $R_9 = 43.9 \pm 0.4 k\ohm$.
    \label{fig: netR44}}
\end{figure}

%=======================
\section*{Controllo proporzionale}
Infine si è costruito il circuito di controllo proporzionale a partire dal
precedente (integrale), scambiando il condensatore $C_1$ con una resistenza
$R_{10} = 100 \; \si{k\ohm}$ (nominali) secondo lo schema in \cref{schm: prop}.
\begin{figure}[htbp]
    \centering
	\includegraphics[scale=0.6]{controlgenprop}
    \caption{Schema circuitale del controllore ad azione proporzionale.
    \label{schm: prop}}
\end{figure}

\section{Risposta ad un'onda quadra}
Esattamente come in \cref{sec: intsqwresp} si è reimpostato il potenziometro
$R_9$ fino alla sua massima resistenza e si è pilotato il driver LED di
disturbo con un'onda quadra compresa tra $0$ e $150 \; \si{m\V}$ con frequenza
fissata a $f = 1 \si{\Hz}$.

Dunque si è studiata nuovamente la risposta del circuito osservando
l'andamento temporale dei segnali nelle uscite \verb+ERROR+, \verb+CONTROL+ e
\verb+MEAS+.
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{proportional}
    \caption{Acquisizione presa dall'oscilloscopio dei segnali
    $V\ped{ERROR}(t)$ (CH1) e dell'onda pilota di disturbo $W_2 (t)$ (CH2).
    \label{fig: properrnoise}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{proportional.meas}
    \caption{Acquisizione dell'andamento nel tempo dei segnali in
    \texttt{ERROR} (CH1) e di \texttt{MEAS} misurato rispetto a \texttt{SET}
    (CH2).
    \label{fig: properrmeas}}
\end{figure}
\begin{figure}[htbp]
    \centering
	\includegraphics[width=\textwidth]{proportional.control}
    \caption{Acquisizione presa dall'oscilloscopio dei segnali
    $V\ped{CONTROL} (t)$ (CH1) e dell'onda pilota del LED di disturbo
    $W_2 (t)$ (CH2).
    \label{fig: propctrlnoise}}
\end{figure}

Come ci si aspettava il controllo proporzionale non mantiene $V\ped{MEAS} (t)$
invariato, dato che il circuito completo non è altro che una cascata di
amplificatori, di cui il primo differenziale di guadagno $\approx 10$, e
il secondo invertente di guadagno variabile in funzione della resistenza del
potenziometro $\frac{R_{10}}{R_9}$.
%=======================
\section*{Conclusioni e commenti finali}
Si è riusciti a studiare il circuito a controllo proporzionale e integrale, riuscendo a verificare le aspettative per entrambe le funzioni utilizzate, e ricostruendo la curva della risposta in frequenza per il circuito.
%=======================
\section*{Dichiarazione}
I firmatari di questa relazione dichiarano che il contenuto della relazione \`e
originale, con misure effettuate dai membri del gruppo, e che tutti i firmatari
hanno contribuito alla elaborazione della relazione stessa.


\end{document}
