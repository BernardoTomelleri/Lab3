\documentclass[10pt, a4paper, italian]{article}
\input{../../latex/preamble}
\input{../../latex/math}
\usepackage{multicol}
\geometry{left=2cm, right=2cm, top=2cm, bottom=2cm}
\usepackage{tkz-graph}
\usetikzlibrary{automata, positioning, arrows}
\newenvironment{FSM}{
\begin{tikzpicture}
\tikzset{
->, % makes the edges directed
>=stealth', % makes the arrow heads bold
node distance=2cm, % specifies the minimum distance between two nodes. Change if necessary.
every state/.style={minimum size = 1cm, thick, fill=gray!10}, % sets the properties for each 'state' node
initial text=$ $, % sets the text that appears on the start arrow
}
}{
\end{tikzpicture}
}

% indexes subsections with letters, sections with numbers (1.a, 1.b, ...)
\renewcommand{\thesubsection}{\thesection.\alph{subsection}}

% lets graphicx know path where figures to be included are found
\graphicspath{{../figs/}}

\author{Gruppo 1.AC \\ Matteo Rossi, Bernardo Tomelleri}
\title{EsD3: Macchine a stati finiti: semafori e riconoscitore di fronti}
\begin{document}
\date{\today}
\maketitle

\section{Misura componenti dei circuiti}
Riportiamo per completezza il valore della tensione continua di
alimentazione per i circuiti integrati misurata con il multimetro
\[
V_{CC} = 4.99 \pm 0.03 \si{\V}
\]

e il valore di capacità del condensatore di disaccoppiamento che collega le
linee di alimentazione a massa (sempre misurato con il multimetro)
\[
C_d = 97 \pm 4 \; \si{n\F}
\]

%=======================
\section{Implementazione di un semaforo con circuiti integrati}\label{sec: IC}
\subsection{Diagramma a stati del semaforo}
Nel caso di semaforo ``abilitato'' i possibili output sono 3 e abbiamo quindi deciso di implementarli con 3 stati interni della macchina; nel caso di semaforo ``disabilitato'' i possibili output sono 2, ma possono essere ottenuti riutilizzando due degli stati precedenti e l'input ``enable'' tramite un'opportuno circuito combinatorio (\texttt{FSM} di Mealy).

Si è deciso di codificare in due bit di memoria i tre stati $ (00) $, $ (01) $ e $ (10) $ che corrispondono, quando $ E = 1 $ (abilitato), ai tre output ``verde'', ``verde-giallo'', ``rosso'' (che si susseguono in modo ciclico). Quando invece $ E = 0 $ (disabilitato) vengono usati solamente $ (00) $ e $ (01) $, che corrispondono agli output del semaforo ``spento'' e ``giallo''.

\begin{center}
\begin{FSM}
\tikzset{
    LabelStyle/.style = {
        rectangle, rounded corners, draw,
        minimum width = 1em,
    },
    EdgeStyle/.append style = {-stealth}
}

   \node[state with output] (V) {$V/Y^-$ \nodepart{lower} $00$};
   \node[state with output, right of=V, xshift=2cm] (VG)
   {$VG/Y^+$ \nodepart{lower} $01$};
   \node[state with output, right of=VG, xshift=2cm] (R)
   {$R$ \nodepart{lower} $10$};
   
   \Edge[label = E](V)(VG)
   \Edge[label = E](VG)(R)

\tikzset{EdgeStyle/.append style = {-stealth, bend right = 30}}
   \Edge[label = D](VG)(V)
   \Edge[label = D](V)(VG)

\tikzset{EdgeStyle/.append style = {bend right = 50}}
   \Edge[label = E](R)(V)

\tikzset{EdgeStyle/.append style = {bend left = 50}}
   \Edge[label = D](R)(V)
\end{FSM}
\end{center}

\subsection{Codifica degli stati della macchina}
La scelta della codifica in termini di bit \`e riassunta nella tabella che segue: $Q_0$ e $Q_1$ rappresentano rispettivamente lo stato delle uscite del primo e del secondo flip-flop e $S$ \`e lo stato associato.
\begin{table}[htbp]
	\centering
	\begin{tabular}{cc|cc}
	\toprule
	$S_E$ &	$S_D$ & $Q_0$ &	$Q_1$ \\
	\midrule
	\midrule
	$Y^-$ & $V$  & $0$	&	$0$	\\
	$Y^+$ & $VG$ & $0$	&	$1$	\\
	 	  & $R$  & $1$	&	$0$	\\
	\bottomrule
	\end{tabular}
	\caption{codifica binaria degli stati del semaforo. \label{tab:bit}}
\end{table}
\subsection{Tabelle di verità}

\subsection{Mappe di Karnaugh e logica combinatoria}

\subsection{Costruzione del circuito}
Si è assemblato il circuito riportato in ~\cref{fig:semaforoSchema} e si
sono collegati i pin \texttt{preset} e \texttt{clear} dei D-FF a
$V_{CC}$ per evitare reset o clear spuri.
\begin{figure}[htbp]
    \centering
    \begin{circuitikz}
        \def\andScale{0.7};
        \def\cusu{-1};
        \def\mano{0.5}
        \def\yep{2}

        % componenti
        %% flip flop
        \draw (0,0) node[flipflop D] (ffSinistra) {};
        \draw (5,0) node[flipflop D] (ffDestra) {};

        %% and
        \node (andSinistra) at (-2, |- ffSinistra.pin 1) [and port, scale=\andScale] {};
        \node (andDestra) at (3, |- ffSinistra.pin 1) [and port, scale=\andScale] {};
        \node [and port, scale=\andScale] (andSopra) at (5,4) {};

        % per i crossing
        \node at ($ (ffSinistra.pin 4) + (\mano,0) $) (ancilla) {};

        %% led
        \node (G) at ($ (andSopra.out) + (3,0) $) {$ G $};
        \node (Y) at ($ (G) + (0,-0.5) $) {$ Y $};
        \node (R) at ($ (G) + (0,-1) $) {$ R $};

        % input
        \node (E) at ($ (andSopra.in 1) + (-9,0) $) {$ E $};
        \node (CLK) at ($ (E)+(0,-7) $) {\texttt{CLK}};

        % fili
        %% clock
        \draw (CLK) -| (ffDestra.pin 3);
        \draw (ffSinistra.pin 3) -- (ffSinistra.pin 3 |-, |- CLK);

        % and e ff
        \draw (andSinistra.out) -- (ffSinistra.pin 1);
        \draw (andDestra.out) -- (ffDestra.pin 1);
        \draw (E) -- (andSopra.in 1);
        \draw (ffSinistra.pin 4) -- ++ (\mano,0) |- (andSopra.in 2);
        \draw (andSinistra.in 2) -| (-3.5, |- E);
        \draw (andDestra.in 1) -- ($ (ffSinistra.pin 4 |-, |- andDestra.in 1) + (\mano,0) $);
        %% cacro del crossing pt 1
        \node at (ffSinistra.pin 4 |-, \yep) [jump crossing] (X1) {};
        \node at (ancilla |-, \yep) [jump crossing] (X2) {};
        \draw (andSinistra.in 1) |- (X1.west);
        \draw (X1.east) -- (X2.west);
        \draw (X2.east) -- (ffDestra.pin 6 |-, \yep);
        %% cancro del crossing pt 2
        \node at ($ (ffDestra.pin 3) + (0,\cusu) $) [jump crossing] (X) {};
        \draw (ffDestra.pin 4) |- (X.east);
        \draw (X.west) -| (andDestra.in 2);

        %% led
        \draw (andSopra.out) -- (G);
        \draw (ffDestra.pin 6) |- (Y);
        %% cancro del crossing
        \node at (ancilla |-, |- R) [jump crossing] (X1) {};
        \node at (ffDestra.pin 6 |-, |- R) [jump crossing] (X2) {};
        \draw (ffSinistra.pin 6) |- (X1.west);
        \draw (X1.east) -- (X2.west);
        \draw (X2.east) -- (R);

        % numeri dei pin
%        \draw (ffSinistra.pin 1) node[above] {2};
%        \draw (ffSinistra.pin 3) node[above] {3};
%        \draw (ffSinistra.pin 4) node[above] {6};
%        \draw (ffSinistra.pin 6) node[below] {5};
%
%        \draw (ffDestra.pin 1) node[above] {12};
%        \draw (ffDestra.pin 3) node[above] {11};
%        \draw (ffDestra.pin 4) node[above] {8};
%        \draw (ffDestra.pin 6) node[below] {9};
    \end{circuitikz}
    \caption{\label{fig:semaforoSchema}schema del semaforo Mealy con enable.}
\end{figure}

Per studiarne il comportamento generiamo nei due pin DIO 0 (CLOCK) e DIO 1
(ENABLE) dell'AD2 due segnali di clock di frequenza $f = \SI{20}{\hertz}$ e
$\SI{2}{\hertz}$ agli ingressi CLK ed $E$ del circuito. 

\subsection{Analisi e verifica del funzionamento del circuito}
\begin{figure}[htbp]
    \centering
    \includegraphics[width=\textwidth]{traffic}
    \caption{Acquisizione di un ciclo completo (frequenza 1 kHz) con Logic
    Analyzer dei segnali in ingresso e in uscita dal semaforo.
    \label{fig: dlatch}}
\end{figure}

%=======================
\section{Implementazione software della logica combinatoria con AD2/ROM}
\subsection{Costruzione del circuito}

\subsection{Implementazione delle tabelle di verità in ROM}

\subsection{Verifica del funzionamento del circuito}

\subsection{Variante svizzera del semaforo ROM}

%=======================
\section{Implementazione in software dei semafori con MCU (Arduino)}
\subsection{Collegamento LED semaforo alle uscite}

\subsection{Definizione interruttore di Enable}

\subsection{Implementazione del codice per la FSM}

\subsection{Versione svizzera del semaforo con Enable via Arduino}

%=======================
\section{Falling-edge detector}
\subsection{Progettazione FSM e costruzione dei circuiti}
Si vuole realizzare una FSM che riceve uno stream di bit su una linea di
ingresso e che accende un LED tutte le volte che si presenta un fronte di
discesa.

\subsection{Definizione dello stream di bit casuali in ingresso}
Con la funzione Patterns di Waveform si invia un segnale di clock di
frequenza $f\ped{clk} = \SI{1}{k\Hz}$ al pin (CLK) del contatore e si
acquisiscono i segnali in uscita con la funzione Logic
dello stesso.

\subsection{Verifica del funzionamento e analisi della temporizzazione}


%=======================
\section*{Conclusioni e commenti finali}
Si è riusciti a verificare il corretto funzionamento di circuiti logici
sequenziali di crescente complessità e svariate applicazioni (e.g., sistemi di
controllo e misura) costruiti con porte NOT, NAND, XOR, D-Latch e contatori
sincroni.
In particolare sono stati realizzati e studiati un D-Latch, uno shift-register
con positive edge-triggered D-FF, un generatore di sequenze pseudocasuali e
alcuni tipi di divisore di frequenza con contatori binari.
Inoltre si è riusciti ad apprezzare l'effetto dei tempi di propagazione
delle porte sul loro comportamento, seppur in maniera limitata dalla bassa
risoluzione temporale dell'AD2.

%=======================
\section*{Dichiarazione}
I firmatari di questa relazione dichiarano che il contenuto della relazione \`e
originale, con misure effettuate dai membri del gruppo, e che tutti i firmatari
hanno contribuito alla elaborazione della relazione stessa.

\end{document}
